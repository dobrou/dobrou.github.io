<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fotorealistické Skákající Míčky</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a202c; 
            touch-action: none; 
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, #2d3748 0%, #1a202c 100%);
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none; 
            z-index: 10;
        }
        
        /* Animace pro plynulé skrytí UI */
        #ui-content {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Třída, která se přidá při nečinnosti */
        .is-idle #ui-content {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none !important;
        }
        
        .pointer-events-auto {
            pointer-events: auto;
        }

        /* Vlastní stylování posuvníku */
        input[type=range] {
            -webkit-appearance: none;
            width: 80px;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body>

    <!-- Vykreslovací plátno -->
    <canvas id="simulationCanvas"></canvas>

    <!-- Uživatelské rozhraní -->
    <div id="ui-layer" class="p-4 flex justify-center w-full">
        <!-- Kompaktní plovoucí lišta s ikonami -->
        <div id="ui-content" class="flex flex-wrap items-center gap-3 md:gap-6 bg-black/40 backdrop-blur-md px-6 py-3 rounded-full shadow-2xl pointer-events-auto border border-white/10">
            
            <!-- Posuvník velikosti -->
            <div class="flex items-center gap-2" title="Velikost přidávané kuličky">
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" stroke-width="2"/></svg>
                <input type="range" id="ballSize" min="10" max="80" value="30">
            </div>

            <!-- Dělící čára -->
            <div class="w-px h-6 bg-white/20 hidden sm:block"></div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                <!-- Tlačítko Přidat -->
                <button id="btn-add" class="text-white hover:text-green-400 p-2 rounded-full transition-colors bg-white/5 hover:bg-white/10" title="Přidat kuličku (lze i pravým tlačítkem)">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </button>

                <!-- Tlačítko Gyroskop -->
                <button id="btn-gyro" class="text-white hover:text-purple-400 p-2 rounded-full transition-colors bg-white/5 hover:bg-white/10" title="Zapnout/Vypnout gyroskop">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01"/></svg>
                </button>

                <!-- Tlačítko Gravitace -->
                <button id="btn-gravity" class="text-white hover:text-blue-400 p-2 rounded-full transition-colors bg-white/5 hover:bg-white/10" title="Zapnout/Vypnout gravitaci">
                    <svg id="icon-gravity" class="w-6 h-6 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                </button>

                <!-- Tlačítko Vymazat -->
                <button id="btn-clear" class="text-white hover:text-red-400 p-2 rounded-full transition-colors bg-white/5 hover:bg-white/10" title="Vymazat všechny kuličky">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');

        // Nastavení fyziky
        let gravityEnabled = true;
        let baseGravity = 0.4;
        let gravityX = 0;
        let gravityY = baseGravity;
        const FRICTION_AIR = 0.998; 
        const RESTITUTION = 0.85; 

        let width, height;
        let balls = [];

        // Proměnné pro interakci (prak)
        let slingshotBall = null;
        let slingshotMousePos = { x: 0, y: 0 };

        // UI elementy
        const sizeSlider = document.getElementById('ballSize');
        let idleTimeout;
        const uiLayer = document.getElementById('ui-layer');

        // Odhalení UI
        function wakeUI() {
            uiLayer.classList.remove('is-idle');
            clearTimeout(idleTimeout);
            // Skryje UI po 2.5s bez aktivity
            idleTimeout = setTimeout(() => {
                uiLayer.classList.add('is-idle');
            }, 2500);
        }

        // Změna velikosti plátna
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            wakeUI();
        }
        window.addEventListener('resize', resize);
        resize();

        // Třída reprezentující jeden míček
        class Ball {
            constructor(x, y, radius, hue) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 20;
                this.vy = (Math.random() - 0.5) * 20;
                this.radius = radius;
                this.mass = radius * radius;
                this.hue = hue;
            }

            draw(ctx) {
                if (!isFinite(this.x) || !isFinite(this.y) || !isFinite(this.radius) || this.radius <= 0) return;

                ctx.save();
                ctx.beginPath();
                const shadowX = this.x + this.radius * 0.15;
                const shadowY = this.y + this.radius * 0.15;
                const shadowRadius = this.radius * 1.3;
                
                let shadowGrad = ctx.createRadialGradient(shadowX, shadowY, 0, shadowX, shadowY, shadowRadius);
                shadowGrad.addColorStop(0, 'rgba(0, 0, 0, 0.4)');
                shadowGrad.addColorStop(1, 'rgba(0, 0, 0, 0)');
                
                ctx.arc(shadowX, shadowY, shadowRadius, 0, Math.PI * 2);
                ctx.fillStyle = shadowGrad;
                ctx.fill();
                ctx.restore();

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                
                const gradientX = this.x - this.radius * 0.3;
                const gradientY = this.y - this.radius * 0.3;
                let gradient = ctx.createRadialGradient(
                    gradientX, gradientY, Math.max(0.1, this.radius * 0.05), 
                    this.x, this.y, this.radius
                );
                
                gradient.addColorStop(0, `hsl(${this.hue}, 90%, 75%)`);
                gradient.addColorStop(0.4, `hsl(${this.hue}, 90%, 45%)`);
                gradient.addColorStop(1, `hsl(${this.hue}, 100%, 15%)`);
                
                ctx.fillStyle = gradient;
                ctx.fill();

                ctx.beginPath();
                const specRadius = this.radius * 0.35;
                const specX = this.x - this.radius * 0.4;
                const specY = this.y - this.radius * 0.4;
                
                ctx.arc(specX, specY, specRadius, 0, Math.PI * 2);
                let specGradient = ctx.createRadialGradient(
                    specX, specY, 0,
                    specX, specY, specRadius
                );
                specGradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                specGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                ctx.fillStyle = specGradient;
                ctx.fill();
            }

            update() {
                if (slingshotBall === this) {
                    this.vx = 0;
                    this.vy = 0;
                    return;
                }

                if (gravityEnabled) {
                    this.vx += gravityX;
                    this.vy += gravityY;
                }

                this.vx *= FRICTION_AIR;
                this.vy *= FRICTION_AIR;

                this.x += this.vx;
                this.y += this.vy;

                if (this.x - this.radius < 0) {
                    this.x = this.radius;
                    this.vx = -this.vx * RESTITUTION;
                    if (Math.abs(this.vx) < Math.abs(gravityX) * 1.5) this.vx = 0;
                } else if (this.x + this.radius > width) {
                    this.x = width - this.radius;
                    this.vx = -this.vx * RESTITUTION;
                    if (Math.abs(this.vx) < Math.abs(gravityX) * 1.5) this.vx = 0;
                }

                if (this.y - this.radius < 0) {
                    this.y = this.radius;
                    this.vy = -this.vy * RESTITUTION;
                    if (Math.abs(this.vy) < Math.abs(gravityY) * 1.5) this.vy = 0;
                } else if (this.y + this.radius > height) {
                    this.y = height - this.radius;
                    this.vy = -this.vy * RESTITUTION;
                    if (Math.abs(this.vy) < Math.abs(gravityY) * 1.5) this.vy = 0;
                }
            }
        }

        function resolveCollisions() {
            for (let i = 0; i < balls.length; i++) {
                for (let j = i + 1; j < balls.length; j++) {
                    let b1 = balls[i];
                    let b2 = balls[j];

                    let dx = b2.x - b1.x;
                    let dy = b2.y - b1.y;
                    let distance = Math.hypot(dx, dy);

                    if (distance === 0) {
                        dx = 0.1;
                        dy = 0.1;
                        distance = Math.hypot(dx, dy);
                    }

                    let minDist = b1.radius + b2.radius;

                    if (distance < minDist) {
                        let penetration = minDist - distance;
                        let nx = dx / distance;
                        let ny = dy / distance;

                        let totalMass = b1.mass + b2.mass;
                        let m1Ratio = b2.mass / totalMass;
                        let m2Ratio = b1.mass / totalMass;

                        if (slingshotBall !== b1) {
                            b1.x -= nx * penetration * m1Ratio;
                            b1.y -= ny * penetration * m1Ratio;
                        }
                        if (slingshotBall !== b2) {
                            b2.x += nx * penetration * m2Ratio;
                            b2.y += ny * penetration * m2Ratio;
                        }

                        let dvx = b2.vx - b1.vx;
                        let dvy = b2.vy - b1.vy;
                        let velocityAlongNormal = dvx * nx + dvy * ny;

                        if (velocityAlongNormal > 0) continue;

                        let jFactor = -(1 + RESTITUTION) * velocityAlongNormal;
                        jFactor /= (1 / b1.mass) + (1 / b2.mass);

                        let impulseX = jFactor * nx;
                        let impulseY = jFactor * ny;

                        if (slingshotBall !== b1) {
                            b1.vx -= impulseX / b1.mass;
                            b1.vy -= impulseY / b1.mass;
                        }
                        if (slingshotBall !== b2) {
                            b2.vx += impulseX / b2.mass;
                            b2.vy += impulseY / b2.mass;
                        }
                    }
                }
            }
        }

        function addBall(x, y) {
            const radius = parseInt(sizeSlider.value) || 30; 
            const hue = Math.floor(Math.random() * 360);
            balls.push(new Ball(x, y, radius, hue));
        }

        // --- Interakce myší a dotykem ---
        canvas.addEventListener('contextmenu', e => e.preventDefault());
        
        function handleInputStart(x, y, button) {
            let hitBall = false;
            
            // Kontrola, zda jsme neklikli na kuličku (od nejnovější po nejstarší)
            for (let i = balls.length - 1; i >= 0; i--) {
                let ball = balls[i];
                let dist = Math.hypot(ball.x - x, ball.y - y);
                if (dist <= ball.radius) {
                    slingshotBall = ball;
                    slingshotMousePos = { x, y };
                    hitBall = true;
                    break;
                }
            }
            
            // Pokud jsme netrefili kuličku, zobrazíme UI (nebo přidáme novou kuličku)
            if (!hitBall) {
                if (button === 2) addBall(x, y);
                wakeUI();
            }
        }

        function handleInputMove(x, y) {
            if (slingshotBall) {
                // Natahujeme prak, UI se NEZOBRAZÍ
                slingshotMousePos = { x, y };
            } else {
                // Jen tak hýbeme myší - probudíme UI
                wakeUI();
            }
        }

        function handleInputEnd(button) {
            if (button === 0 && slingshotBall) {
                // Vystřelení
                let dx = slingshotBall.x - slingshotMousePos.x;
                let dy = slingshotBall.y - slingshotMousePos.y;
                slingshotBall.vx = dx * 0.15;
                slingshotBall.vy = dy * 0.15;
                slingshotBall = null;
            } else {
                wakeUI();
            }
        }

        canvas.addEventListener('mousedown', (e) => handleInputStart(e.clientX, e.clientY, e.button));
        window.addEventListener('mousemove', (e) => handleInputMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', (e) => handleInputEnd(e.button));

        canvas.addEventListener('touchstart', (e) => {
            if (e.target !== canvas) return;
            e.preventDefault();
            handleInputStart(e.touches[0].clientX, e.touches[0].clientY, 0);
        }, { passive: false });
        window.addEventListener('touchmove', (e) => {
            if (e.target !== canvas) return;
            e.preventDefault();
            handleInputMove(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });
        window.addEventListener('touchend', () => handleInputEnd(0));

        // --- Tlačítka UI ---
        const btnAdd = document.getElementById('btn-add');
        btnAdd.addEventListener('click', () => {
            wakeUI();
            addBall(width / 2, height / 2);
        });

        const iconGravity = document.getElementById('icon-gravity');
        const btnGravity = document.getElementById('btn-gravity');
        btnGravity.addEventListener('click', () => {
            wakeUI();
            gravityEnabled = !gravityEnabled;
            // Animace ikony (otočení šipky nahoru/dolů) a změna barvy
            if (gravityEnabled) {
                iconGravity.classList.remove('rotate-180');
                btnGravity.classList.remove('text-gray-500');
            } else {
                iconGravity.classList.add('rotate-180');
                btnGravity.classList.add('text-gray-500');
            }
        });

        const btnClear = document.getElementById('btn-clear');
        btnClear.addEventListener('click', () => {
            wakeUI();
            balls = [];
        });

        // --- Gyroskop ---
        let useGyro = false;
        const btnGyro = document.getElementById('btn-gyro');

        function handleOrientation(e) {
            if (!useGyro) return;
            let gamma = e.gamma; 
            let beta = e.beta;   

            if (gamma === null || beta === null) return;

            if (beta > 90) beta = 90;
            if (beta < -90) beta = -90;

            let angle = window.screen && window.screen.orientation ? window.screen.orientation.angle : window.orientation || 0;
            let maxG = 1.0; 

            if (angle === 90) {
                gravityX = (beta / 90) * maxG;
                gravityY = (-gamma / 90) * maxG;
            } else if (angle === -90 || angle === 270) {
                gravityX = (-beta / 90) * maxG;
                gravityY = (gamma / 90) * maxG;
            } else {
                gravityX = (gamma / 90) * maxG;
                gravityY = (beta / 90) * maxG;
            }
        }

        btnGyro.addEventListener('click', async () => {
            wakeUI();
            if (!useGyro) {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            useGyro = true;
                        } else {
                            alert("Přístup ke gyroskopu byl zamítnut.");
                            return;
                        }
                    } catch (err) {
                        console.error(err);
                        return;
                    }
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                    useGyro = true;
                }
                btnGyro.classList.add('text-yellow-400');
            } else {
                window.removeEventListener('deviceorientation', handleOrientation);
                useGyro = false;
                btnGyro.classList.remove('text-yellow-400');
                gravityX = 0;
                gravityY = baseGravity;
            }
        });

        // --- Hlavní herní smyčka ---
        function animate() {
            ctx.clearRect(0, 0, width, height);

            balls.forEach(ball => ball.update());
            resolveCollisions();
            balls.forEach(ball => ball.draw(ctx));

            // Vykreslení gumičky praku
            if (slingshotBall) {
                ctx.beginPath();
                ctx.moveTo(slingshotBall.x, slingshotBall.y);
                ctx.lineTo(slingshotMousePos.x, slingshotMousePos.y);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 10]); 
                ctx.stroke();
                ctx.setLineDash([]); 
            }

            requestAnimationFrame(animate);
        }

        setTimeout(() => {
            for(let i=0; i<5; i++) {
                addBall(width * 0.2 + (width * 0.6 * Math.random()), height * 0.2 + (height * 0.4 * Math.random()));
            }
        }, 100);

        animate();

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kompas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none; /* Zak√°≈æe p≈ôibl√≠≈æen√≠ ≈°t√≠pnut√≠m */
        }
        .compass-dial, #sun-pointer, #moon-pointer {
            transition: transform 0.2s ease-out;
        }
        /* Zaji≈°tƒõn√≠, aby ikony Slunce/Mƒõs√≠ce byly nad ƒç√°rkami stup≈à≈Ø */
        #sun-pointer, #moon-pointer {
            z-index: 5;
        }
        /* Zaji≈°tƒõn√≠, aby ƒç√≠seln√≠k byl pod ikonami, ale nad znaƒçkami */
        .compass-dial {
            z-index: 4;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen overflow-hidden">

    <div id="permission-container" class="text-center p-8">
        <h1 class="text-3xl font-bold mb-4">Digit√°ln√≠ kompas</h1>
        <p class="text-gray-400 mb-6">Pro zobrazen√≠ kompasu a polohy Slunce a Mƒõs√≠ce, pros√≠m, povolte p≈ô√≠stup k senzor≈Øm orientace za≈ô√≠zen√≠ a k va≈°√≠ poloze.</p>
        <button id="permission-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
            Povolit p≈ô√≠stup
        </button>
    </div>

    <div id="compass-container" class="hidden flex flex-col items-center justify-center relative">
        <!-- Vnƒõj≈°√≠ kruh kompasu -->
        <div class="relative w-80 h-80 md:w-96 md:h-96 rounded-full bg-gray-800 shadow-2xl border-4 border-gray-700 flex items-center justify-center">
            
            <!-- Statick√© znaƒçky svƒõtov√Ωch stran -->
            <span class="absolute top-2 text-3xl font-bold text-red-500 z-10">S</span>
            <span class="absolute bottom-2 text-2xl font-bold text-gray-400 z-10">J</span>
            <span class="absolute left-4 text-2xl font-bold text-gray-400 z-10">Z</span>
            <span class="absolute right-4 text-2xl font-bold text-gray-400 z-10">V</span>

            <!-- Znaƒçky stup≈à≈Ø -->
            <div class="absolute w-full h-full">
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(30deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(60deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(120deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(150deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(210deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(240deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(300deg) translateY(-9rem);"></div>
                <div class="absolute top-1/2 left-1/2 w-px h-4 bg-gray-500" style="transform: translateX(-50%) translateY(-50%) rotate(330deg) translateY(-9rem);"></div>
            </div>

            <!-- Ukazatel Slunce -->
            <div id="sun-pointer" class="absolute w-full h-full">
                <span class="absolute top-8 text-3xl" style="left: 50%; transform: translateX(-50%);">‚òÄÔ∏è</span>
            </div>

            <!-- Ukazatel Mƒõs√≠ce -->
            <div id="moon-pointer" class="absolute w-full h-full">
                <span class="absolute top-8 text-3xl" style="left: 50%; transform: translateX(-50%);">üåô</span>
            </div>

            <!-- Cifern√≠k kompasu, kter√Ω se ot√°ƒç√≠ -->
            <div class="compass-dial w-full h-full">
                 <!-- St≈ôelka -->
                <div class="absolute top-1/2 left-1/2 w-1 h-32 bg-red-500 rounded-full" style="transform: translateX(-50%) translateY(-100%); transform-origin: bottom center;"></div>
                <div class="absolute top-1/2 left-1/2 w-1 h-32 bg-gray-400 rounded-full" style="transform: translateX(-50%) translateY(0%); transform-origin: top center;"></div>
                 <!-- St≈ôedov√Ω bod -->
                <div class="absolute top-1/2 left-1/2 w-4 h-4 bg-white rounded-full border-2 border-gray-900" style="transform: translate(-50%, -50%); z-index: 6;"></div>
            </div>
            
            <!-- Zobrazen√≠ stup≈à≈Ø uprost≈ôed -->
            <div id="degree-display" class="absolute z-10 text-5xl font-mono font-bold text-white">
                0¬∞
            </div>
        </div>
         <p id="error-message" class="mt-8 text-center text-red-400 p-4"></p>
    </div>

    <script>
        const permissionContainer = document.getElementById('permission-container');
        const permissionBtn = document.getElementById('permission-btn');
        const compassContainer = document.getElementById('compass-container');
        const compassDial = document.querySelector('.compass-dial');
        const degreeDisplay = document.getElementById('degree-display');
        const errorMessage = document.getElementById('error-message');
        const sunPointer = document.getElementById('sun-pointer');
        const moonPointer = document.getElementById('moon-pointer');

        let userCoords = null;

        function showError(message) {
            errorMessage.textContent = message;
            compassContainer.classList.add('hidden');
            permissionContainer.classList.remove('hidden');
            permissionBtn.style.display = 'none';
            permissionContainer.querySelector('h1').textContent = 'Chyba';
            permissionContainer.querySelector('p').textContent = message;
        }
        
        // Funkce pro aktualizaci polohy nebesk√Ωch tƒõles
        function updateCelestialPositions() {
            if (!userCoords) return;

            const now = new Date();
            const { latitude, longitude } = userCoords;

            // V√Ωpoƒçet pozice Slunce
            const sunPos = SunCalc.getPosition(now, latitude, longitude);
            const sunAzimuth = sunPos.azimuth * 180 / Math.PI + 180; // P≈ôevod na stupnƒõ a korekce
            sunPointer.style.transform = `rotate(${sunAzimuth}deg)`;

            // V√Ωpoƒçet pozice Mƒõs√≠ce
            const moonPos = SunCalc.getMoonPosition(now, latitude, longitude);
            const moonAzimuth = moonPos.azimuth * 180 / Math.PI + 180; // P≈ôevod na stupnƒõ a korekce
            moonPointer.style.transform = `rotate(${moonAzimuth}deg)`;
        }


        function handleOrientation(event) {
            let heading = event.webkitCompassHeading || event.alpha;

            if (typeof heading === 'undefined' || heading === null) {
                showError('Va≈°e za≈ô√≠zen√≠ nebo prohl√≠≈æeƒç neposkytuje informace o smƒõru.');
                return;
            }

            // Ot√°ƒç√≠me cifern√≠kem kompasu, ne cel√Ωm kompasem.
            // Ikony Slunce a Mƒõs√≠ce z≈Øst√°vaj√≠ na m√≠stƒõ vzhledem k S, J, V, Z.
            let rotation = 360 - heading;

            compassDial.style.transform = `rotate(${rotation}deg)`;
            degreeDisplay.textContent = `${Math.round(heading)}¬∞`;
        }

        function requestPermissions() {
             // 1. Z√≠sk√°n√≠ opr√°vnƒõn√≠ pro orientaci
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                            requestGeolocation(); // Pokraƒçujeme na geolokaci
                        } else {
                            showError('P≈ô√≠stup k orientaci za≈ô√≠zen√≠ byl zam√≠tnut.');
                        }
                    })
                    .catch((error) => {
                        console.error(error);
                        showError('Nastala chyba p≈ôi ≈æ√°dosti o p≈ô√≠stup k orientaci.');
                    });
            } else if ('DeviceOrientationEvent' in window) {
                 window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                 requestGeolocation(); // Pokraƒçujeme na geolokaci
            } else {
                 showError('V√°≈° prohl√≠≈æeƒç nepodporuje Device Orientation API.');
            }
        }

        function requestGeolocation() {
            // 2. Z√≠sk√°n√≠ opr√°vnƒõn√≠ pro geolokaci
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userCoords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        
                        // V≈°echna opr√°vnƒõn√≠ udƒõlena, zobraz√≠me kompas
                        permissionContainer.classList.add('hidden');
                        compassContainer.classList.remove('hidden');
                        
                        // Poprv√© aktualizujeme polohy a pak ka≈ædou minutu
                        updateCelestialPositions();
                        setInterval(updateCelestialPositions, 60000); 
                    },
                    (error) => {
                        showError('P≈ô√≠stup k poloze byl zam√≠tnut nebo nen√≠ k dispozici.');
                        console.error('Geolocation error:', error);
                    }
                );
            } else {
                showError('V√°≈° prohl√≠≈æeƒç nepodporuje Geolocation API.');
            }
        }


        // P≈ôipojen√≠ event listeneru k tlaƒç√≠tku
        permissionBtn.addEventListener('click', requestPermissions);

        // Kontrola HTTPS, proto≈æe senzory jsou zabezpeƒçen√° funkce
        if (window.location.protocol !== 'https:') {
            showError('Tato funkce je dostupn√° pouze na zabezpeƒçen√©m (HTTPS) p≈ôipojen√≠.');
            permissionBtn.disabled = true;
        }

    </script>
</body>
</html>
